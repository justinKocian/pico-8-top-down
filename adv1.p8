pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
--=callbacks=--

-- init
function _init()
	--state--
	state="start"

	--putbacks--
	putbacks={}

	setup_game()
end

-- update
function _update()
	if state=="play" then
		u_play()
	elseif state=="start" then
		u_start()
	elseif state=="win" then
		u_win()
	end
end

function u_play()
	move_plr()
end

function u_start()
	if btnp(â) then
		state="play"
	end
end

function u_win()
	if btnp(â) then
		setup_game()
		state="start"
	end
end

-- draw
function _draw()
	cls()
	do_state()
end

function do_state()
	if state=="play" then
		d_play()
	elseif state=="start" then
		d_start()
	elseif state=="win" then
		d_win()
	end
end

function d_play()
	d_map()
	d_plr()
	d_ui()
end

function d_start()
	print("press â to start",30,60)
end

function d_win()
	print("you win!",34,60)
end

function d_map()
	map()
	pickups()
end

-- setup
function setup_game()
	--map tile key--
	tile = {
		empty=17,
		potion=32
	}
	
	--debug mode toggle--
	debug=false

	--game settings--
	goal=3

	--init stuff--
	init_plr()
	init_ui()
	put_putbacks_back()
end

function put_putbacks_back()
	--putbacks--
	for t in all(putbacks) do
		mset(t[1],t[2],tile.potion)
	end

	putbacks={}
end

-->8
--animation--

function d_plr()
	if plr.atk then
		local half=plr.atk_len/2
		local fr=(plr.atk_t>half) and plr.atk_up or plr.atk_dn
		spr(fr, plr.x, plr.y, 1, 1, plr.flp)
		return
	end

	-- normal walk animation
	if plr.f>2.9 then
		plr.f=1
	else
		plr.f+=.1
	end

	spr(plr.f, plr.x, plr.y, 1, 1, plr.flp)
end


-->8
--pickups--

function pickups()

	local ptx=(plr.x+4)/8
	local pty=(plr.y+4)/8

	spover=mget(ptx,pty)

	if spover==tile.potion then
		mset(ptx,pty,tile.empty)

		add(putbacks,{ptx,pty})

		points+=1

		if points>=goal then
			sfx(1)
			state="win"
		else
			sfx(0)
		end
	end

	if debug then
		print(spover)
	end
end


-->8
--ui--

function init_ui()
	points=0
end

function d_ui()
	print("points: "..points)
end


-->8
--player--

function init_plr()
	plr={
		x=63,
		y=63,
		f=1,        -- walk animation frame
		flp=false,  -- facing direction

		-- attack frames
		atk_up=3,
		atk_dn=4,

		-- attack state
		atk=false,
		atk_t=0,
		atk_len=8,

		spd=1
	}
end


function move_plr()
	local lx=plr.x
	local ly=plr.y

	-- movement
	if btn(â¬…ï¸) then
		plr.x-=plr.spd
		plr.flp=true
	end
	if btn(â¡ï¸) then
		plr.x+=plr.spd
		plr.flp=false
	end
	if btn(â¬†ï¸) then
		plr.y-=plr.spd
	end
	if btn(â¬‡ï¸) then
		plr.y+=plr.spd
	end

	-- attack
	if btnp(ğŸ…¾ï¸) and plr.atk_t<=0 then
		plr.atk=true
		plr.atk_t=plr.atk_len
	end

	-- attack timer countdown
	if plr.atk_t>0 then
		plr.atk_t-=1
		if plr.atk_t<=0 then
			plr.atk=false
		end
	end

	-- collision
	local ptx=(plr.x+4)/8
	local pty=(plr.y+4)/8

	if fget(mget(ptx,pty),0) then
		plr.x=lx
		plr.y=ly
	end
end
__gfx__
00000000888000000000000088700000888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000806666008880000080766600806666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700006111008066660000711100006111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000006616000061110000761600006616000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000054555500066160004445550055545500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700464777700545555000656560004677770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000004666004647777000466600006646000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000006006000040060000600600006006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111dddddd111555511115ddd1111111111115dd1110000000000000000000000000000000000000000000000000000000000000000
111111211111111111111111dd2ddddd1577775115ddddd1115ddd1115dd5d110000000000000000000000000000000000000000000000000000000000000000
111112111111111111155511dddddddd5777777515d55dd115ddddd115d5dd110000000000000000000000000000000000000000000000000000000000000000
12111211111111111155d551dddddddd5777777515ddddd115d55dd1115dd1110000000000000000000000000000000000000000000000000000000000000000
112111111111111115555d51dddddddd5d7777d515d5d5d115ddd5d1115dd1110000000000000000000000000000000000000000000000000000000000000000
112111111111111115555551dddddddd5dddddd515ddddd115ddddd115d5dd110000000000000000000000000000000000000000000000000000000000000000
111111111111111122555552ddddd2dd15dddd5115dd5dd1111111115dddddd10000000000000000000000000000000000000000000000000000000000000000
1111111111111111122255211dddddd115dddd511111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11777711000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11177111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11222211000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11288211000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11222211000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000100010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1414141414141414141414141414141411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1410101012101710161510101510171411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1410101111111011111111111110101411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1412111111111617101711151115111411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1411111111112011111011111010101411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1411111111111117111016111717111411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1411112011131313131313131313131311111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1411111111101111132010101010101411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1411171617161111131015161516171411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1410101011102011131111111111111411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1410151711111713131115111116151411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1410111011111113111111111111111411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1410171115161013111115171111151411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1411111111101313111111111111111411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1411111611161312111115151616171411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1414141414141314141414141414141411111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000300000000000000000001831018310193201b33021330013002030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000002372023720237202372025720277202b7202a7202a7202a7202b7202b7200070000700007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700
